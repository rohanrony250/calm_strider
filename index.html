<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Calm Strider â€” Capture & View</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg:#0b1320; --card:#121a33; --ink:#e9eef6; --mut:#a8b3cf; --line:#1f2a4a;
    --accent:#5bc0ff; --ok:#6df0a8; --warn:#ffd580; --err:#ff8797;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:#111a2e;padding:10px 14px;box-shadow:0 2px 12px rgba(0,0,0,.35);display:flex;gap:10px;align-items:center;justify-content:space-between}
  h1{font-size:17px;margin:0;font-weight:700;letter-spacing:.2px}
  .sub{font-size:12px;color:var(--mut)}
  main{max-width:1200px;margin:0 auto;padding:14px}
  .row{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button,input[type="range"]{
    appearance:none;background:#1a2550;border:1px solid #2b3c67;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer
  }
  select{min-width:220px}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1730;font-size:12px}
  .statgrid{display:grid;grid-template-columns:repeat(7,minmax(110px,1fr));gap:10px}
  .stat{background:#0f1730;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  .k{font-size:11px;color:var(--mut)}
  .v{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:16px}
  .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  #map{height:420px;border-radius:12px}
  canvas{background:#0f1730;border-radius:12px;border:1px solid var(--line)}
  .tabs{display:flex;gap:8px;margin:10px 0}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1730;cursor:pointer;font-weight:600}
  .tab.active{outline:2px solid #2b3c67}
  .section{display:none}
  .section.active{display:block}
  .log{max-height:220px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f1730;border:1px solid var(--line);border-radius:12px;padding:8px}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .hint{font-size:12px;color:var(--mut)}
  @media (max-width:1020px){ .row{grid-template-columns:1fr} .statgrid{grid-template-columns:repeat(3,1fr)} #map{height:360px} }
</style>
</head>
<body>
<header>
  <div>
    <h1>ðŸ“± Calm Strider â€” Capture & View</h1>
    <div class="sub">Capture sensors + upload + live view</div>
  </div>
  <div class="flex">
    <button id="shareBtn" title="Copy share link">Share</button>
    <button id="helpBtn" title="Help">Help</button>
  </div>
</header>

<main>

  <!-- CAPTURE controls -->
  <div class="card">
    <div class="controls">
      <strong>Capture:</strong>
      <button id="permBtn">Request Permissions</button>
      <button id="startCapBtn">Start Capture</button>
      <button id="stopCapBtn" disabled>Stop</button>
      <button id="startMicBtn">Start Mic</button>
      <button id="stopMicBtn" disabled>Stop Mic</button>
      <span class="pill">Mode
        <select id="modeSel">
          <option value="throttle" selected>Event-throttle</option>
          <option value="timer">Fixed-interval</option>
        </select>
      </span>
      <span class="pill">Rate
        <select id="rateSel">
          <option value="0.5">0.5 Hz</option>
          <option value="1">1 Hz</option>
          <option value="2">2 Hz</option>
          <option value="5">5 Hz</option>
          <option value="10">10 Hz</option>
          <option value="20" selected>20 Hz</option>
          <option value="50">50 Hz</option>
          <option value="60">60 Hz</option>
          <option value="raw">raw</option>
        </select>
      </span>
      <span id="capStatus" class="hint right"></span>
    </div>
  </div>

  <!-- VIEW controls -->
  <div class="card">
    <div class="controls">
      <strong>View:</strong>
      <label>Session:
        <select id="sessionSel"></select>
      </label>
      <button id="listenBtn">Listen live</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="recenterBtn" disabled>Recenter map</button>
      <span class="pill">Auto-follow <input id="followChk" type="checkbox" checked/></span>
      <span class="pill">Accuracy max: <span id="accVal">150</span> m <input id="accRange" type="range" min="10" max="300" value="150" step="5" /></span>
      <span id="status" class="hint right"></span>
    </div>
  </div>

  <!-- Stats -->
  <div class="card">
    <div class="statgrid">
      <div class="stat"><div class="k">Samples</div><div class="v" id="sCount">0</div></div>
      <div class="stat"><div class="k">Comfort</div>
        <div class="v"><span id="comfort">â€”</span> <span id="comfortBadge" class="badge">â€”</span></div>
        <div class="hint" id="comfortBreak"></div>
      </div>
      <div class="stat"><div class="k">Speed m/s</div><div class="v" id="spd">â€”</div></div>
      <div class="stat"><div class="k">Accel |a|</div><div class="v" id="amag">â€”</div></div>
      <div class="stat"><div class="k">Noise dBFS</div><div class="v" id="noise">â€”</div><div class="hint" id="noiseHint"></div></div>
      <div class="stat"><div class="k">Temp Â°C</div><div class="v" id="temp">â€”</div></div>
      <div class="stat"><div class="k">Wind m/s Â· Rain mm/h</div><div class="v"><span id="wind">â€”</span> Â· <span id="rain">â€”</span></div></div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="map">Map</div>
    <div class="tab" data-tab="charts">Charts</div>
    <div class="tab" data-tab="log">Log</div>
  </div>

  <div class="row section active" id="sec-map">
    <div class="card"><div id="map"></div></div>
    <div class="card">
      <div class="k">Last point</div>
      <div class="v" id="lastPoint">â€”</div>
      <div style="height:10px"></div>
      <div class="k">Session meta</div>
      <div class="v" id="sessMeta">â€”</div>
      <div style="height:10px"></div>
      <div class="k">Skipped (accuracy)</div>
      <div class="v" id="skipAcc">0</div>
      <div class="k">Skipped (invalid coords)</div>
      <div class="v" id="skipBad">0</div>
    </div>
  </div>

  <div class="row section" id="sec-charts">
    <div class="card"><canvas id="chartAccel" height="200"></canvas></div>
    <div class="card"><canvas id="chartNoise" height="200"></canvas></div>
  </div>

  <div class="section" id="sec-log">
    <div class="card"><div class="k">Event log</div><pre id="log" class="log"></pre></div>
  </div>

</main>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- Firebase + App code -->
<script type="module">
  /* ---------------- Firebase init ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getDatabase, ref, child, get, set, update, push, query, orderByKey, limitToLast, onChildAdded, off } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0yzdcWJxsO3dtqWlTJyEjupV8_mdzm0E",
    authDomain: "urban-app-be1f9.firebaseapp.com",
    databaseURL: "https://urban-app-be1f9-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "urban-app-be1f9",
    appId: "1:297008657169:web:e9a9aadf8332b71a6392b0"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  /* ---------------- UI refs ---------------- */
  const permBtn     = document.getElementById('permBtn');
  const startCapBtn = document.getElementById('startCapBtn');
  const stopCapBtn  = document.getElementById('stopCapBtn');
  const startMicBtn = document.getElementById('startMicBtn');
  const stopMicBtn  = document.getElementById('stopMicBtn');
  const modeSel     = document.getElementById('modeSel');
  const rateSel     = document.getElementById('rateSel');
  const capStatus   = document.getElementById('capStatus');

  const sessionSel  = document.getElementById('sessionSel');
  const listenBtn   = document.getElementById('listenBtn');
  const stopBtn     = document.getElementById('stopBtn');
  const recenterBtn = document.getElementById('recenterBtn');
  const followChk   = document.getElementById('followChk');
  const accRange    = document.getElementById('accRange');
  const accVal      = document.getElementById('accVal');
  const statusEl    = document.getElementById('status');

  const sCountEl    = document.getElementById('sCount');
  const comfortEl   = document.getElementById('comfort');
  const comfortBadge= document.getElementById('comfortBadge');
  const comfortBreak= document.getElementById('comfortBreak');
  const spdEl       = document.getElementById('spd');
  const amagEl      = document.getElementById('amag');
  const noiseEl     = document.getElementById('noise');
  const noiseHint   = document.getElementById('noiseHint');
  const tempEl      = document.getElementById('temp');
  const windEl      = document.getElementById('wind');
  const rainEl      = document.getElementById('rain');
  const lastPointEl = document.getElementById('lastPoint');
  const sessMetaEl  = document.getElementById('sessMeta');
  const skipAccEl   = document.getElementById('skipAcc');
  const skipBadEl   = document.getElementById('skipBad');

  const logEl       = document.getElementById('log');
  const shareBtn    = document.getElementById('shareBtn');
  const helpBtn     = document.getElementById('helpBtn');

  /* ---------------- Tabs ---------------- */
  const tabs = document.querySelectorAll('.tab');
  const secMap = document.getElementById('sec-map');
  const secCharts = document.getElementById('sec-charts');
  const secLog = document.getElementById('sec-log');
  tabs.forEach(t=>t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab;
    [secMap, secCharts, secLog].forEach(s=>s.classList.remove('active'));
    ({map:secMap, charts:secCharts, log:secLog}[id]).classList.add('active');
    if (id==='map') setTimeout(()=>map.invalidateSize(), 50);
  }));

  /* ---------------- Utils ---------------- */
  function log(msg, cls=''){ const line=document.createElement('div'); line.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; if (cls) line.className=cls; logEl.appendChild(line); logEl.scrollTop=logEl.scrollHeight; }
  function num(v){ if (v===null || v===undefined || v==='') return null; const n = typeof v==='string' ? parseFloat(v) : +v; return Number.isFinite(n) ? n : null; }
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

  /* ---------------- Map ---------------- */
  const map = L.map('map',{ zoomControl:true }).setView([53.3498,-6.2603], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'Â© OpenStreetMap' }).addTo(map);
  let track = L.polyline([], {color: '#5bc0ff', weight: 4, opacity:.95}).addTo(map);
  let marker = L.circleMarker([0,0], {radius:6, color:'#fff', weight:2, fillColor:'#1abc9c', fillOpacity:0.9}).addTo(map);
  let gotFirstFix=false, lastLatLng=null, AUTO_FOLLOW=true;
  let ACCURACY_MAX = parseInt(accRange.value,10);
  let skippedAcc = 0, skippedBad=0;

  accRange.addEventListener('input', ()=>{ ACCURACY_MAX=parseInt(accRange.value,10); accVal.textContent=ACCURACY_MAX; });
  followChk.addEventListener('change', ()=>{ AUTO_FOLLOW = followChk.checked; });

  function goodCoord(r){
    const lat = num(r.lat), lon = num(r.lon);
    if (lat==null || lon==null || Math.abs(lat)>90 || Math.abs(lon)>180){ skippedBad++; skipBadEl.textContent=String(skippedBad); return null; }
    const acc = num(r.accuracy_m); if (acc!=null && acc>ACCURACY_MAX){ skippedAcc++; skipAccEl.textContent=String(skippedAcc); return null; }
    return [lat,lon];
  }

  /* ---------------- Charts ---------------- */
  const accelChart = new Chart(document.getElementById('chartAccel'),{
    type:'line', data:{labels:[], datasets:[{label:'|a| m/sÂ²', data:[], tension:.2, borderWidth:2, pointRadius:0}]},
    options:{animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}}
  });
  const noiseChart = new Chart(document.getElementById('chartNoise'),{
    type:'line', data:{labels:[], datasets:[{label:'dBFS', data:[], tension:.2, borderWidth:2, pointRadius:0}]},
    options:{animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}}
  });
  function pushChart(chart,label,val){ if(val==null) return; const d=chart.data; d.labels.push(label); d.datasets[0].data.push(val); if(d.labels.length>800){ d.labels.shift(); d.datasets[0].data.shift(); } chart.update('none'); }

  /* ---------------- Comfort ---------------- */
  function comfortScoreParts(aStd, dbfs, precip, wind){
    const pRough = clamp((aStd||0)*12, 0, 40);
    const baseDb = (dbfs!=null ? dbfs : -50); // dbfs negative
    const pNoise = clamp((baseDb + 60) * 0.8, 0, 25);
    const pRain  = clamp((precip||0)*10, 0, 20);
    const pWind  = clamp((wind||0)*2, 0, 15);
    const score  = clamp(Math.round(100 - pRough - pNoise - pRain - pWind), 0, 100);
    return { score, pRough, pNoise, pRain, pWind };
  }
  function rollStdPush(arr, val, win=20){ if(val==null) return 0; arr.push(val); if(arr.length>win) arr.shift(); const n=arr.length, mean=arr.reduce((a,b)=>a+b,0)/n; const v=arr.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n; return Math.sqrt(v); }

  /* ---------------- Data stream fan-in ---------------- */
  // Any producer (local capture OR Firebase listener) can call feedRow(r) to update UI.
  let lastAmagVals=[];
  function feedRow(r){
    // Tiles
    const aTot = num(r.a_total), db=num(r.db_smooth!=null ? r.db_smooth : r.dbfs), spd=num(r.speed_mps);
    const tC=num(r.w_temp_c), wMps=num(r.w_wind_mps), rain=num(r.w_precip_mm);
    if (spd!=null) spdEl.textContent = spd.toFixed(2);
    if (aTot!=null) amagEl.textContent = aTot.toFixed(2);
    if (db!=null){ noiseEl.textContent = db.toFixed(1); noiseHint.textContent=''; } else { noiseEl.textContent='â€”'; noiseHint.textContent='No mic data (start mic if capturing)'; }
    if (tC!=null) tempEl.textContent=tC.toFixed(1);
    if (wMps!=null) windEl.textContent=wMps.toFixed(1);
    if (rain!=null) rainEl.textContent=rain.toFixed(2);

    // Comfort + actuation
    const std = rollStdPush(lastAmagVals, aTot, 20);
    const parts = comfortScoreParts(std, db, rain, wMps);
    comfortEl.textContent = parts.score;
    comfortBadge.textContent = parts.score>=70 ? 'Good' : parts.score>=50 ? 'OK' : 'Low';
    comfortBadge.className = 'badge ' + (parts.score>=70 ? 'ok' : parts.score>=50 ? 'warn' : 'err');
    comfortBreak.textContent = `penalties: rough ${parts.pRough.toFixed(1)}, noise ${parts.pNoise.toFixed(1)}, rain ${parts.pRain.toFixed(1)}, wind ${parts.pWind.toFixed(1)}`;
    if (parts.score<50){ if(navigator.vibrate) navigator.vibrate(100); try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=660; o.connect(g); g.connect(ctx.destination); g.gain.value=0.03; o.start(); setTimeout(()=>{o.stop();ctx.close();},120);}catch(e){} }

    // Map
    const latlng = goodCoord(r);
    if(latlng){
      lastLatLng=latlng; track.addLatLng(latlng); marker.setLatLng(latlng);
      if(!gotFirstFix){ gotFirstFix=true; map.setView(latlng,16); recenterBtn.disabled=false; log(`map centered @ ${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)}`,'ok'); }
      else if (AUTO_FOLLOW){ map.panTo(latlng, {animate:false}); }
      lastPointEl.textContent = `${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)} (accâ‰¤${ACCURACY_MAX}m)`;
    } else {
      const lat = r.lat ?? 'null', lon=r.lon ?? 'null', acc=r.accuracy_m ?? 'null';
      log(`skip row: lat=${lat} lon=${lon} acc=${acc}`, 'warn');
    }

    // Charts
    const lbl = r.timestamp_ms ? new Date(+r.timestamp_ms).toLocaleTimeString() : '';
    pushChart(accelChart, lbl, aTot);
    pushChart(noiseChart, lbl, db);

    // counter
    sCountEl.textContent = String((+sCountEl.textContent||0)+1);
  }

  /* ---------------- WEATHER (Open-Meteo) ---------------- */
  let latestWeather = null; let weatherTimer=null;
  async function fetchWeather(lat, lon){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,precipitation`;
      const j = await fetch(url).then(r=>r.json());
      const c = j.current || j.current_weather || {};
      latestWeather = {
        w_temp_c: (c.temperature_2m!=null ? c.temperature_2m : c.temperature),
        w_wind_mps: (c.wind_speed_10m!=null ? c.wind_speed_10m : c.windspeed),
        w_precip_mm: c.precipitation ?? 0,
        w_ts: Date.now(),
        w_source: 'open-meteo'
      };
      log(`[cloud] weather updated: ${latestWeather.w_temp_c}Â°C, wind ${latestWeather.w_wind_mps} m/s, rain ${latestWeather.w_precip_mm} mm/h`,'ok');
    }catch(e){ log(`[cloud] weather error: ${e.message}`,'err'); }
  }

  /* ---------------- CAPTURE (sensors + upload) ---------------- */
  let recording=false, sessionId=null, buffer=[], flushTimer=null, minIntervalMs=50, intervalMs=50, writeMode='throttle', lastWriteTs=0, timerId=null;
  let lastAx=null,lastAy=null,lastAz=null,lastAmag=null, latestGeo=null, watchId=null, motionHandler=null;
  let audioCtx=null, analyser=null, micStream=null, micRaf=null, micActive=false, lastDbfs=null, lastDbSmooth=null;
  let sampleId=0;

  function hasMotionSupport(){ return 'DeviceMotionEvent' in window; }
  function hasGeoSupport(){ return 'geolocation' in navigator; }

  async function requestPermissions(){
    try{
      if (!hasMotionSupport()){ log('DeviceMotion not supported','err'); }
      else if (typeof DeviceMotionEvent.requestPermission==='function'){ const resp = await DeviceMotionEvent.requestPermission(); log(`Motion permission: ${resp}`, resp==='granted'?'ok':'err'); }
      else { log('Motion permission: not required','ok'); }
      if (hasGeoSupport()){
        await new Promise(resolve=>{
          navigator.geolocation.getCurrentPosition(
            (pos)=>{ latestGeo=pos; log('Location permission granted','ok'); resolve(); },
            (err)=>{ log('Location permission error: '+err.message,'err'); resolve(); },
            { enableHighAccuracy:true, timeout:7000, maximumAge:0 }
          );
        });
      } else { log('Geolocation not supported','err'); }
    }catch(e){ log('Permission request error: '+e.message,'err'); }
  }

  function startMic(){
    if (micActive) return;
    if (!navigator.mediaDevices?.getUserMedia){ log('Mic not supported','err'); return; }
    navigator.mediaDevices.getUserMedia({audio:true, video:false}).then(stream=>{
      micStream=stream;
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      return audioCtx.resume().then(()=>{
        analyser = audioCtx.createAnalyser(); analyser.fftSize=2048;
        audioCtx.createMediaStreamSource(stream).connect(analyser);
        micActive=true; startMicBtn.disabled=true; stopMicBtn.disabled=false;
        const buf=new Float32Array(analyser.fftSize); const alpha=0.2;
        const tick=()=>{
          if (!micActive) return;
          analyser.getFloatTimeDomainData(buf);
          let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum+=v*v; }
          const rms = Math.sqrt(sum/buf.length)+1e-12;
          lastDbfs = 20*Math.log10(rms);
          lastDbSmooth = (lastDbSmooth==null)? lastDbfs : (alpha*lastDbfs + (1-alpha)*lastDbSmooth);
          noiseEl.textContent = lastDbSmooth.toFixed(1);
          noiseHint.textContent = '';
          micRaf = requestAnimationFrame(tick);
        };
        tick();
        log('Mic started (dBFS only; no audio saved)','ok');
      });
    }).catch(e=>log('Mic error: '+e.message,'err'));
  }
  function stopMic(){
    if (!micActive) return;
    micActive=false; if(micRaf) cancelAnimationFrame(micRaf), micRaf=null;
    micStream?.getTracks().forEach(t=>t.stop()); micStream=null;
    audioCtx?.close(); audioCtx=null; analyser=null; lastDbfs=null;
    startMicBtn.disabled=false; stopMicBtn.disabled=true; noiseHint.textContent='Mic stopped';
    log('Mic stopped','ok');
  }

  function applyRate(v){
    if (v==='raw'){ minIntervalMs=0; intervalMs=0; log('Rate: raw (no throttle)','ok'); return; }
    const hz = parseFloat(v); const ms = Math.max(1, Math.round(1000/hz));
    if (writeMode==='throttle'){ minIntervalMs=ms; log(`Throttle: ~${hz} Hz (${ms} ms)`,'ok'); }
    else { intervalMs=ms; if(timerId){ clearInterval(timerId); timerId=setInterval(()=>{ if(recording) pushRow(Date.now()); }, intervalMs);} log(`Fixed-interval: ${hz} Hz (${ms} ms)`,'ok'); }
  }

  function startCapture(){
    if (recording) return;
    // new session
    sessionId = (crypto?.randomUUID?.() || String(Date.now()));
    set(ref(db, `public/sessions/${sessionId}/meta`), { startedAt: Date.now(), sdk: 'web-all-in-one' });
    capStatus.textContent = `session: ${sessionId}`;
    log(`[cloud] session: public/sessions/${sessionId}`, 'ok');

    // timers
    buffer.length=0; sampleId=0; lastWriteTs=0; recording=true;
    startCapBtn.disabled=true; stopCapBtn.disabled=false;

    // start weather fetcher once we have a fix; also run every 60s
    if (latestGeo?.coords){ fetchWeather(latestGeo.coords.latitude, latestGeo.coords.longitude); }
    if (weatherTimer) clearInterval(weatherTimer);
    weatherTimer = setInterval(()=>{
      if (latestGeo?.coords){ fetchWeather(latestGeo.coords.latitude, latestGeo.coords.longitude); }
    }, 60_000);

    // GPS
    if (hasGeoSupport()){
      watchId = navigator.geolocation.watchPosition((pos)=>{
        latestGeo=pos;
      }, (err)=>log('GPS error: '+err.message,'warn'), { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
    }

    // Motion
    motionHandler = (ev)=>{
      const aIncG = ev.accelerationIncludingGravity || ev.acceleration || {};
      lastAx = aIncG.x ?? null; lastAy = aIncG.y ?? null; lastAz = aIncG.z ?? null;
      lastAmag = (lastAx!=null && lastAy!=null && lastAz!=null) ? Math.sqrt(lastAx*lastAx + lastAy*lastAy + lastAz*lastAz) : null;
      if (writeMode==='throttle'){
        const now = Date.now(); if (minIntervalMs && (now-lastWriteTs) < minIntervalMs) return;
        lastWriteTs = now; pushRow(now);
      }
    };
    window.addEventListener('devicemotion', motionHandler, {passive:true});

    // Timer mode
    if (writeMode==='timer'){
      if (timerId) clearInterval(timerId);
      timerId = setInterval(()=>{ pushRow(Date.now()); }, intervalMs);
    }

    // Flush loop
    if (flushTimer) clearInterval(flushTimer);
    flushTimer = setInterval(flushBuffer, 1000);

    log('Capture started','ok');
  }

  function stopCapture(){
    if (!recording) return;
    recording=false; startCapBtn.disabled=false; stopCapBtn.disabled=true;
    if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    if (motionHandler){ window.removeEventListener('devicemotion', motionHandler); motionHandler=null; }
    if (timerId){ clearInterval(timerId); timerId=null; }
    if (flushTimer){ clearInterval(flushTimer); flushTimer=null; }
    if (weatherTimer){ clearInterval(weatherTimer); weatherTimer=null; }
    flushBuffer().then(()=> log('Capture stopped (final flush done)','ok'));
  }

  function makeRow(now){
    const g = latestGeo ? latestGeo.coords : {};
    const row = {
      timestamp_iso: new Date(now).toISOString(),
      timestamp_ms: now,
      lat: g?.latitude ?? null,
      lon: g?.longitude ?? null,
      accuracy_m: g?.accuracy ?? null,
      altitude_m: g?.altitude ?? null,
      speed_mps: g?.speed ?? null,
      heading_deg: g?.heading ?? null,
      ax: lastAx, ay: lastAy, az: lastAz,
      a_total: lastAmag,
      dbfs: lastDbfs,
      db_smooth: lastDbSmooth,
      mic_active: micActive ? 1 : 0,
      tag: null,
      sample_id: sampleId++,
      // merge latest weather snapshot
      ...(latestWeather||{})
    };
    return row;
  }

  function pushRow(now){
    const row = makeRow(now);
    buffer.push(row);
    feedRow(row); // instant UI
  }

  async function flushBuffer(){
    if (!sessionId || buffer.length===0) return;
    const updates = {};
    for (const row of buffer){
      const key = push(ref(db, `public/sessions/${sessionId}/readings`)).key;
      updates[`public/sessions/${sessionId}/readings/${key}`] = row;
    }
    const n = buffer.length; buffer = [];
    try{
      await update(ref(db), updates);
      log(`[cloud] uploaded ${n} row(s) â†’ public/sessions/${sessionId}`,'ok');
    }catch(e){
      log(`[cloud] upload error: ${e.message}`,'err');
    }
  }

  /* ---------------- VIEW (listen from Firebase) ---------------- */
  let detach=null, activeReadingsPath=null;

  async function resolveReadingsPath(sessionId){
    const base=`public/sessions/${sessionId}`;
    const sn

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobile Sensor Logger</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#0b1320; color:#e9eef6; }
    header { padding: 16px 20px; background: #111a2e; box-shadow: 0 2px 10px rgba(0,0,0,.2); position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 18px; letter-spacing:.3px; }
    main { padding: 20px; max-width: 900px; margin: 0 auto; }
    .card { background:#121a33; border:1px solid #1f2a4a; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items: center; }
    button { appearance:none; border:1px solid #2b3c67; background:#1a2550; color:#e9eef6; padding: 10px 14px; border-radius: 12px; cursor:pointer; font-weight:600; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .stat { min-width: 140px; background:#0f1730; border:1px solid #1f2a4a; padding:10px 12px; border-radius:12px; text-align:left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size: 12px; opacity:.8; }
    a.link { color:#8cc8ff; text-decoration: none; border-bottom: 1px dashed #8cc8ff; }
    .log { max-height: 220px; overflow: auto; background:#0f1730; border:1px solid #1f2a4a; padding:10px; border-radius: 12px; }
    .ok { color:#6df0a8 }
    .warn { color:#ffd580 }
    .err { color:#ff8797 }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“± Mobile Sensor Logger â€” Accelerometer + GPS + (opt) Mic</h1>
  </header>
  <main>
    <div class="card">
      <p>Use this on your phone to record accelerometer, GPS, and optional microphone <em>loudness</em> (no audio saved). It runs entirely in the browser and saves a CSV locally (no server needed).</p>
      <ol>
        <li>Tap <strong>Request Permissions</strong> (iOS requires this for motion/location; mic is optional).</li>
        <li>Tap <strong>Start</strong>. Optionally tap <strong>Start Mic</strong> to log dB (relative dBFS).</li>
        <li>Walk/ride, optionally use <strong>Tag</strong> to mark events.</li>
        <li>Tap <strong>Stop</strong> â†’ <strong>Stop Mic</strong> (if used) â†’ <strong>Download CSV</strong>.</li>
      </ol>
      <p class="small">Columns: timestamp_iso, timestamp_ms, lat, lon, accuracy_m, altitude_m, speed_mps, heading_deg, ax, ay, az, a_total, rot_alpha_dps, rot_beta_dps, rot_gamma_dps, <strong>dbfs, db_smooth, mic_active, tag</strong>, sample_id</p>
    </div>

    <div class="card">
      <div class="row" style="gap:8px; margin-bottom:12px;">
        <button id="permBtn">Request Permissions</button>
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="downloadBtn" disabled>Download CSV</button>
        <button id="startMicBtn">Start Mic</button>
        <button id="stopMicBtn" disabled>Stop Mic</button>
        <button id="tagBtn">Tag</button>
        <label class="small" style="display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #2b3c67; border-radius:10px; background:#0f1730;">
          Rate
          <select id="rateSel" class="mono" style="background:#0f1730; color:#e9eef6; border:1px solid #2b3c67; border-radius:8px; padding:4px 6px;">
            <option value="10">10 Hz</option>
            <option value="20" selected>20 Hz</option>
            <option value="50">50 Hz</option>
            <option value="60">60 Hz</option>
            <option value="raw">raw</option>
          </select>
        </label>
      </div>
      <div class="row">
        <div class="stat"><div class="small">Samples</div><div class="mono" id="samples">0</div></div>
        <div class="stat"><div class="small">GPS Fix</div><div class="mono" id="gps">â€”</div></div>
        <div class="stat"><div class="small">Speed (m/s)</div><div class="mono" id="speed">â€”</div></div>
        <div class="stat"><div class="small">Accel |a| (m/sÂ²)</div><div class="mono" id="amag">â€”</div></div>
        <div class="stat"><div class="small">Noise (dBFS)</div><div class="mono" id="db">â€”</div></div>
        <div class="stat"><div class="small">Mic</div><div class="mono" id="mic">off</div></div>
        <div class="stat"><div class="small">Tags</div><div class="mono" id="tags">0</div></div>
      </div>
    </div>

    <div class="card">
      <div class="small">Status</div>
      <pre class="log mono" id="log"></pre>
    </div>
  </main>

<script>
(function(){
  const permBtn = document.getElementById('permBtn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const samplesEl = document.getElementById('samples');
  const gpsEl = document.getElementById('gps');
  const speedEl = document.getElementById('speed');
  const amagEl = document.getElementById('amag');
  const dbEl = document.getElementById('db');
  const micEl = document.getElementById('mic');
  const tagsEl = document.getElementById('tags');
  const logEl = document.getElementById('log');
  const rateSel = document.getElementById('rateSel');

  let recording = false;
  let watchId = null;
  let latestGeo = null;
  let data = [];
  let sampleId = 0;
  let motionHandler = null;

  // Audio (mic) state
  let audioCtx = null, analyser = null, micStream = null, micRaf = null;
  let micActive = false;
  let lastDbfs = null, lastDbSmooth = null;

  // Tagging
  let tags = [];
  let lastTag = null; // attached to next sample then cleared

  // Sampling throttle
  let minIntervalMs = 50; // default 20 Hz
  let lastWriteTs = 0; // attached to next sample then cleared

  const log = (msg, cls='') => {
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    if (cls) line.className = cls;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  };

  function hasMotionSupport(){
    return 'DeviceMotionEvent' in window;
  }

  function hasGeoSupport(){
    return 'geolocation' in navigator;
  }

  async function requestPermissions(){
    try {
      if (!hasMotionSupport()) {
        log('DeviceMotion not supported on this device.', 'err');
      } else if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const resp = await DeviceMotionEvent.requestPermission();
        log(`Motion permission: ${resp}`, resp === 'granted' ? 'ok' : 'err');
      } else {
        log('Motion permission: not required on this device', 'ok');
      }

      if (hasGeoSupport()) {
        await new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (pos) => { latestGeo = pos; log('Location permission granted', 'ok'); resolve(); },
            (err) => { log('Location permission error: ' + err.message, 'err'); resolve(); },
            { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }
          );
        });
      } else {
        log('Geolocation not supported on this device.', 'err');
      }
    } catch (e) {
      log('Permission request error: ' + e.message, 'err');
    }
  }

  function start(){
    if (recording) return;
    data = [];
    sampleId = 0;
    lastWriteTs = 0;
    recording = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    downloadBtn.disabled = true;
    log('Recording started', 'ok');

    if (hasGeoSupport()) {
      watchId = navigator.geolocation.watchPosition((pos) => {
        latestGeo = pos;
        const s = pos.coords.speed; // m/s (may be null)
        gpsEl.textContent = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)} Â±${(pos.coords.accuracy||0).toFixed(0)}m`;
        speedEl.textContent = (s!=null? s.toFixed(2): 'â€”');
      }, (err) => {
        log('GPS error: ' + err.message, 'warn');
      }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 });
    }

    motionHandler = (ev) => {
      if (!recording) return;
      const now = Date.now();
      if (minIntervalMs && (now - lastWriteTs) < minIntervalMs) return; // throttle
      lastWriteTs = now;
      const t = now;
      const aIncG = ev.accelerationIncludingGravity || {};
      const a = ev.acceleration || {};
      const r = ev.rotationRate || {};
      // Prefer includingGravity for |a| (more stable in pocket/bag)
      const ax = (aIncG.x ?? a.x ?? null), ay = (aIncG.y ?? a.y ?? null), az = (aIncG.z ?? a.z ?? null);
      const amag = (ax!=null && ay!=null && az!=null) ? Math.sqrt(ax*ax + ay*ay + az*az) : null;

      if (amag!=null) amagEl.textContent = amag.toFixed(2); else amagEl.textContent = 'â€”';
      if (lastDbSmooth!=null) dbEl.textContent = lastDbSmooth.toFixed(1);

      const g = latestGeo ? latestGeo.coords : {};
      const row = {
        timestamp_iso: new Date(t).toISOString(),
        timestamp_ms: t,
        lat: g.latitude ?? null,
        lon: g.longitude ?? null,
        accuracy_m: g.accuracy ?? null,
        altitude_m: g.altitude ?? null,
        speed_mps: g.speed ?? null,
        heading_deg: g.heading ?? null,
        ax, ay, az,
        a_total: amag,
        rot_alpha_dps: r.alpha ?? null,
        rot_beta_dps: r.beta ?? null,
        rot_gamma_dps: r.gamma ?? null,
        dbfs: lastDbfs,
        db_smooth: lastDbSmooth,
        mic_active: micActive ? 1 : 0,
        tag: lastTag,
        sample_id: sampleId++
      };
      data.push(row);
      samplesEl.textContent = String(data.length);
      // consume one-shot tag after attaching to a row
      if (lastTag) lastTag = null;
    };

    window.addEventListener('devicemotion', motionHandler, { passive: true });

    // Fallback: if no motion events after 5s, warn.
    setTimeout(() => {
      if (recording && data.length === 0) log('No motion samples yet. On iOS, tap "Request Permissions" and move the phone slightly.', 'warn');
    }, 5000);
  }

  function stop(){
    if (!recording) return;
    recording = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    downloadBtn.disabled = data.length === 0;

    if (watchId != null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    if (motionHandler) { window.removeEventListener('devicemotion', motionHandler); motionHandler = null; }

    log(`Recording stopped. ${data.length} samples captured.`, 'ok');
  }

  // --- CSV builder (refactored for testability) ---
  function buildCSV(headers, rows){
    const esc = (v) => {
      if (v == null) return '';
      const s = String(v);
      const needsQuotes = /[",\n\r]/.test(s);
      const q = s.replace(/"/g, '""');
      return needsQuotes ? '"' + q + '"' : q;
    };
    let out = headers.join(',') + '\n';
    for (const row of rows){
      out += headers.map(h => esc(row[h])).join(',') + '\n';
    }
    return out;
  }

  function downloadCSV(){
    if (!data.length) { log('Nothing to download', 'warn'); return; }
    const headers = [
      'timestamp_iso','timestamp_ms','lat','lon','accuracy_m','altitude_m','speed_mps','heading_deg',
      'ax','ay','az','a_total','rot_alpha_dps','rot_beta_dps','rot_gamma_dps',
      'dbfs','db_smooth','mic_active','tag','sample_id'
    ];
    const csv = buildCSV(headers, data);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const ts = new Date().toISOString().replaceAll(':','-');
    a.download = `sensor_log_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    log('CSV downloaded', 'ok');
  }

  // Mic helpers
  async function startMic(){
    try{
      if (micActive) return;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        log('Mic not supported on this browser.', 'err');
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      micStream = stream;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      const src = audioCtx.createMediaStreamSource(stream);
      src.connect(analyser);
      micActive = true;
      document.getElementById('startMicBtn').disabled = true;
      document.getElementById('stopMicBtn').disabled = false;
      micEl.textContent = 'on';

      const buf = new Float32Array(analyser.fftSize);
      const alpha = 0.2; // smoothing for dB
      const update = () => {
        if (!micActive) return;
        analyser.getFloatTimeDomainData(buf);
        let sum = 0; for (let i=0;i<buf.length;i++){ const v=buf[i]; sum += v*v; }
        const rms = Math.sqrt(sum / buf.length) + 1e-12;
        lastDbfs = 20 * Math.log10(rms);
        lastDbSmooth = (lastDbSmooth==null) ? lastDbfs : (alpha*lastDbfs + (1-alpha)*lastDbSmooth);
        dbEl.textContent = lastDbSmooth.toFixed(1);
        micRaf = requestAnimationFrame(update);
      };
      update();
      log('Mic started (dBFS, relative; no audio stored).', 'ok');
    }catch(e){
      log('Mic error: ' + e.message, 'err');
    }
  }
  function stopMic(){
    if (!micActive) return;
    micActive = false;
    if (micRaf) cancelAnimationFrame(micRaf), micRaf = null;
    if (micStream) { micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
    if (audioCtx) { audioCtx.close(); audioCtx=null; }
    analyser=null; lastDbfs=null; // keep lastDbSmooth visible to show last value
    document.getElementById('startMicBtn').disabled = false;
    document.getElementById('stopMicBtn').disabled = true;
    micEl.textContent = 'off';
    log('Mic stopped', 'ok');
  }

  // Tag helper: attaches label to the next sample row
  function addTag(){
    const label = prompt('Tag label (e.g., obstruction, ramp, noise, note:...)');
    if (!label) return;
    const t = Date.now();
    tags.push({ ts: t, label });
    lastTag = label; // attach to next motion sample
    tagsEl.textContent = String(tags.length);
    log('Tagged: ' + label, 'ok');
  }

  // --- Self-tests (basic) ---
  function runSelfTests(){
    // 1) CSV newline bug should be fixed
    (function(){
      const H = ['a','b'];
      const R = [{a:1,b:2}];
      const csv = buildCSV(H,R);
      const lines = csv.split('\n');
      const ok = lines.length >= 2 && lines[0] === 'a,b' && lines[1].startsWith('1,2');
      log('[test] CSV newline construction', ok ? 'ok' : 'err');
    })();

    // 2) Quoting with commas and quotes
    (function(){
      const H = ['x'];
      const R = [{x:'he said, "hi"'}];
      const csv = buildCSV(H,R);
      const ok = csv.includes('"he said, ""hi"""');
      log('[test] CSV quoting commas/quotes', ok ? 'ok' : 'err');
    })();

    // 3) Quoting with newlines
    (function(){
      const H = ['y'];
      const R = [{y:'line1\nline2'}];
      const csv = buildCSV(H,R);
      const ok = csv.includes('"line1\nline2"');
      log('[test] CSV quoting newlines', ok ? 'ok' : 'err');
    })();
  }

  // Wire up UI
  permBtn.addEventListener('click', requestPermissions);
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  downloadBtn.addEventListener('click', downloadCSV);
  document.getElementById('startMicBtn').addEventListener('click', startMic);
  document.getElementById('stopMicBtn').addEventListener('click', stopMic);
  document.getElementById('tagBtn').addEventListener('click', addTag);
  rateSel.addEventListener('change', () => {
    const v = rateSel.value;
    if (v === 'raw') { minIntervalMs = 0; log('Sampling rate: raw (no throttle)', 'ok'); }
    else { const hz = parseFloat(v); minIntervalMs = Math.max(0, Math.round(1000 / hz)); log(`Sampling rate: ${hz} Hz (~${minIntervalMs} ms)`, 'ok'); }
  });

  // Hints
  if (!hasMotionSupport()) log('This browser does not support DeviceMotion API. Try a modern mobile browser.', 'err');
  if (!hasGeoSupport()) log('Geolocation not available.', 'warn');

  // Run basic self-tests once
  runSelfTests();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Calm Strider â€” Logger</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;background:#0b1320;color:#e9eef6}
    header{padding:14px 18px;background:#111a2e;box-shadow:0 2px 10px rgba(0,0,0,.3);
      position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px}
    .sub{font-size:12px;color:#a8b3cf}
    main{padding:16px;max-width:980px;margin:0 auto}
    .card{background:#121a33;border:1px solid #1f2a4a;border-radius:16px;padding:14px;
      margin-bottom:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select{appearance:none;border:1px solid #2b3c67;background:#1a2550;color:#e9eef6;
      padding:8px 12px;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      border:1px solid #2b3c67;background:#0f1730;font-size:12px}
    .statgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px}
    .stat{background:#0f1730;border:1px solid #1f2a4a;padding:8px 10px;border-radius:12px}
    .k{font-size:11px;color:#a8b3cf}
    .v{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:16px}
    .small{font-size:12px;color:#a8b3cf}
    .log{max-height:260px;overflow:auto;background:#0f1730;border:1px solid #1f2a4a;
      padding:8px;border-radius:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .ok{color:#6df0a8} .warn{color:#ffd580} .err{color:#ff8797}
    @media(max-width:640px){header{padding:12px 14px} main{padding:12px}}
  </style>
</head>
<body>
<header>
  <h1>ðŸ“± Calm Strider â€” Logger</h1>
  <div class="sub">Collect accelerometer + GPS + optional mic, upload to Firebase, and export CSV</div>
</header>

<main>
  <div class="card">
    <p class="small">
      This page runs on your phone. It records
      <strong>accelerometer (DeviceMotion), GPS (Geolocation), and optional mic loudness (Web Audio)</strong>.
      Every ~1 s, it uploads a batch of readings to Firebase Realtime Database under
      <code>/public/sessions/{sessionId}/readings</code>. It also lets you download a CSV locally.
    </p>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:10px;gap:8px;">
      <button id="permBtn">Request Permissions</button>
      <button id="startBtn">Start Capture</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="downloadBtn" disabled>Download CSV</button>
      <button id="startMicBtn">Start Mic</button>
      <button id="stopMicBtn" disabled>Stop Mic</button>
      <button id="tagBtn">Tag</button>
      <span class="pill">Mode
        <select id="modeSel">
          <option value="throttle" selected>Event-throttle</option>
          <option value="timer">Fixed-interval</option>
        </select>
      </span>
      <span class="pill">Rate
        <select id="rateSel">
          <option value="0.5">0.5 Hz</option>
          <option value="1">1 Hz</option>
          <option value="2">2 Hz</option>
          <option value="5">5 Hz</option>
          <option value="10">10 Hz</option>
          <option value="20" selected>20 Hz</option>
          <option value="50">50 Hz</option>
          <option value="60">60 Hz</option>
          <option value="raw">raw</option>
        </select>
      </span>
    </div>
    <div class="row" style="margin-bottom:8px;gap:8px;">
      <span class="pill small">Session: <span id="sessionLabel">â€”</span></span>
      <span class="pill small">Route: <span id="routeLabel">â€”</span></span>
      <span class="pill small">Cloud: <span id="cloudStatus">idle</span></span>
    </div>
    <div class="statgrid">
      <div class="stat"><div class="k">Samples</div><div class="v" id="samples">0</div></div>
      <div class="stat"><div class="k">GPS Fix</div><div class="v" id="gps">â€”</div></div>
      <div class="stat"><div class="k">Speed (m/s)</div><div class="v" id="speed">â€”</div></div>
      <div class="stat"><div class="k">Accel |a| (m/sÂ²)</div><div class="v" id="amag">â€”</div></div>
      <div class="stat"><div class="k">Noise (dBFS)</div><div class="v" id="db">â€”</div></div>
      <div class="stat"><div class="k">Mic</div><div class="v" id="mic">off</div></div>
      <div class="stat"><div class="k">Tags</div><div class="v" id="tags">0</div></div>
    </div>
  </div>

  <div class="card">
    <div class="small">Status / Debug log</div>
    <pre class="log" id="log"></pre>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getDatabase, ref, set, update, push } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0yzdcWJxsO3dtqWlTJyEjupV8_mdzm0E",
    authDomain: "urban-app-be1f9.firebaseapp.com",
    databaseURL: "https://urban-app-be1f9-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "urban-app-be1f9",
    appId: "1:297008657169:web:e9a9aadf8332b71a6392b0"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // --- DOM refs ---
  const permBtn      = document.getElementById('permBtn');
  const startBtn     = document.getElementById('startBtn');
  const stopBtn      = document.getElementById('stopBtn');
  const downloadBtn  = document.getElementById('downloadBtn');
  const samplesEl    = document.getElementById('samples');
  const gpsEl        = document.getElementById('gps');
  const speedEl      = document.getElementById('speed');
  const amagEl       = document.getElementById('amag');
  const dbEl         = document.getElementById('db');
  const micEl        = document.getElementById('mic');
  const tagsEl       = document.getElementById('tags');
  const logEl        = document.getElementById('log');
  const rateSel      = document.getElementById('rateSel');
  const modeSel      = document.getElementById('modeSel');
  const sessionLabel = document.getElementById('sessionLabel');
  const routeLabelEl = document.getElementById('routeLabel');
  const cloudStatus  = document.getElementById('cloudStatus');
  const startMicBtn  = document.getElementById('startMicBtn');
  const stopMicBtn   = document.getElementById('stopMicBtn');
  const tagBtn       = document.getElementById('tagBtn');

  const log = (msg, cls='') => {
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    if (cls) line.className = cls;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  };

  const hasMotionSupport = () => 'DeviceMotionEvent' in window;
  const hasGeoSupport    = () => 'geolocation' in navigator;

  // capture state
  let recording=false;
  let data=[];
  let sampleId=0;
  let lastAx=null,lastAy=null,lastAz=null,lastAmag=null;
  let latestGeo=null,watchId=null,motionHandler=null;
  let lastTag=null,tags=[],lastDbfs=null,lastDbSmooth=null,micActive=false;
  let writeMode='throttle',minIntervalMs=50,intervalMs=50,lastWriteTs=0,timerId=null;
  let audioCtx=null,analyser=null,micStream=null,micRaf=null;
  let sessionId=null;
  let buffer=[],flushTimer=null;
  const FLUSH_MS=1000,BUFFER_MAX=50;
  let latestWeather=null,weatherTimer=null;

  // --- permissions (with clear iOS messaging) ---
  async function requestPermissions(){
    try{
      if (!hasMotionSupport()){
        log('DeviceMotion not supported on this device.','err');
      } else if (typeof DeviceMotionEvent.requestPermission === 'function'){
        let resp='denied';
        try { resp = await DeviceMotionEvent.requestPermission(); }
        catch { resp='denied'; }
        if (resp === 'granted'){
          log('Motion permission: granted âœ…','ok');
        } else {
          log('Motion permission: denied âŒ (check iOS Settings â†’ Safari â†’ â€œMotion & Orientation Accessâ€).','err');
          alert(
            'Motion permission was denied by iOS.\n\n' +
            'To fix this:\n' +
            '1. Open the Settings app.\n' +
            '2. Go to â€œSafariâ€.\n' +
            '3. Turn ON â€œMotion & Orientation Accessâ€.\n' +
            '4. Force-quit Safari/Chrome, reopen this page, and tap "Request Permissions" again.'
          );
        }
      } else {
        log('Motion permission: not required on this device','ok');
      }

      if (hasGeoSupport()){
        await new Promise(resolve=>{
          navigator.geolocation.getCurrentPosition(
            (pos)=>{ latestGeo=pos; log('Location permission: granted âœ…','ok'); resolve(); },
            (err)=>{ log('Location permission error: '+err.message,'err'); resolve(); },
            { enableHighAccuracy:true, timeout:7000, maximumAge:0 }
          );
        });
      } else {
        log('Geolocation not supported on this device.','err');
      }
    }catch(e){
      log('Permission request error: '+e.message,'err');
    }
  }

  // --- mic with clearer errors ---
  async function startMic(){
    try{
      if (micActive) return;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        log('Mic not supported on this browser.','err');
        alert('Microphone is not supported in this browser on this device.');
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
      micStream = stream;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      audioCtx.createMediaStreamSource(stream).connect(analyser);
      micActive=true;
      startMicBtn.disabled=true; stopMicBtn.disabled=false; micEl.textContent='on';

      const buf=new Float32Array(analyser.fftSize);
      const alpha=0.2;
      const update=()=>{
        if (!micActive) return;
        analyser.getFloatTimeDomainData(buf);
        let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum+=v*v; }
        const rms=Math.sqrt(sum/buf.length)+1e-12;
        lastDbfs=20*Math.log10(rms);
        lastDbSmooth=(lastDbSmooth==null)?lastDbfs:(alpha*lastDbfs+(1-alpha)*lastDbSmooth);
        dbEl.textContent=lastDbSmooth.toFixed(1);
        micRaf=requestAnimationFrame(update);
      };
      update();
      log('Mic started (dBFS only; no audio stored).','ok');
    }catch(e){
      log('Mic error: '+e.message,'err');
      alert(
        'Microphone access failed:\n' + e.message + '\n\n' +
        'On iPhone, check:\n' +
        '1. Settings â†’ Privacy & Security â†’ Microphone â†’ allow your browser.\n' +
        '2. In Safari, tap "aA" â†’ Website Settings â†’ Microphone â†’ Allow.\n' +
        'Then reload this page and tap "Start Mic" again.'
      );
    }
  }
  function stopMic(){
    if (!micActive) return;
    micActive=false;
    if (micRaf) cancelAnimationFrame(micRaf),micRaf=null;
    if (micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
    if (audioCtx){ audioCtx.close(); audioCtx=null; }
    analyser=null; lastDbfs=null;
    startMicBtn.disabled=false; stopMicBtn.disabled=true;
    micEl.textContent='off'; log('Mic stopped','ok');
  }

  // CSV builder
  function buildCSV(headers, rows){
    const esc=v=>{
      if (v==null) return '';
      const s=String(v);
      const needsQuote=/[",\n\r]/.test(s);
      const q=s.replace(/"/g,'""');
      return needsQuote?`"${q}"`:q;
    };
    let out=headers.join(',')+'\n';
    for(const row of rows){
      out+=headers.map(h=>esc(row[h])).join(',')+'\n';
    }
    return out;
  }

  function makeRow(now){
    const g=latestGeo?latestGeo.coords:{};
    return {
      timestamp_iso:new Date(now).toISOString(),
      timestamp_ms:now,
      lat:g?.latitude ?? null,
      lon:g?.longitude ?? null,
      accuracy_m:g?.accuracy ?? null,
      altitude_m:g?.altitude ?? null,
      speed_mps:g?.speed ?? null,
      heading_deg:g?.heading ?? null,
      ax:lastAx, ay:lastAy, az:lastAz,
      a_total:lastAmag,
      dbfs:lastDbfs,
      db_smooth:lastDbSmooth,
      mic_active:micActive?1:0,
      tag:lastTag,
      sample_id:sampleId++,
      ...(latestWeather || {})
    };
  }

  function pushRow(now){
    const row=makeRow(now);
    data.push(row);
    samplesEl.textContent=String(data.length);
    if (lastTag) lastTag=null;
    buffer.push(row);
    if (buffer.length>=BUFFER_MAX) flushBuffer();
  }

  async function flushBuffer(){
    if (!sessionId || buffer.length===0) return;
    const updates={};
    for(const row of buffer){
      const key=push(ref(db,`public/sessions/${sessionId}/readings`)).key;
      updates[`public/sessions/${sessionId}/readings/${key}`]=row;
    }
    const count=buffer.length; buffer=[];
    try{
      await update(ref(db),updates);
      log(`[cloud] uploaded ${count} row(s) â†’ public/sessions/${sessionId}`,'ok');
      cloudStatus.textContent=`sent ${count}`;
    }catch(e){
      log('[cloud] upload error: '+e.message,'err');
      cloudStatus.textContent='error';
    }
  }

  // weather from Open-Meteo
  async function fetchWeather(lat,lon){
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,precipitation`;
      const j=await fetch(url).then(r=>r.json());
      const c=j.current || j.current_weather || {};
      latestWeather={
        w_temp_c:c.temperature_2m ?? c.temperature ?? null,
        w_wind_mps:c.wind_speed_10m ?? c.windspeed ?? null,
        w_precip_mm:c.precipitation ?? 0,
        w_ts:Date.now(),
        w_source:'open-meteo'
      };
      log(`[cloud] weather updated: ${latestWeather.w_temp_c}Â°C, wind ${latestWeather.w_wind_mps} m/s, rain ${latestWeather.w_precip_mm} mm/h`,'ok');
    }catch(e){ log('[cloud] weather error: '+e.message,'err'); }
  }
  function startWeatherLoop(){
    if (weatherTimer) clearInterval(weatherTimer);
    const tick=async()=>{
      if (latestGeo?.coords){
        await fetchWeather(latestGeo.coords.latitude,latestGeo.coords.longitude);
      }
    };
    tick();
    weatherTimer=setInterval(tick,60_000);
  }
  function stopWeatherLoop(){ if (weatherTimer) clearInterval(weatherTimer),weatherTimer=null; }

  function applyRate(v){
    if (v==='raw'){ minIntervalMs=0; intervalMs=0; log('Rate: raw (no throttle)','ok'); return; }
    const hz=parseFloat(v); const ms=Math.max(1,Math.round(1000/hz));
    if (writeMode==='throttle'){ minIntervalMs=ms; log(`Throttle: ~${hz} Hz (${ms} ms)`,'ok'); }
    else{
      intervalMs=ms;
      if (timerId){
        clearInterval(timerId);
        timerId=setInterval(()=>{ if(recording) pushRow(Date.now()); },intervalMs);
      }
      log(`Fixed-interval: ${hz} Hz (${ms} ms)`,'ok');
    }
  }

  function startCapture(){
    if (recording) return;

    // ask for route name (new)
    let rLabel = prompt('Route name for this walk (e.g., "Home â†’ Campus via park")');
    if (!rLabel || !rLabel.trim()){
      const tsLabel = new Date().toISOString().replace('T',' ').slice(0,16);
      rLabel = `Walk ${tsLabel}`;
    }
    routeLabelEl.textContent = rLabel;

    data=[]; sampleId=0; buffer=[];
    lastWriteTs=0; recording=true;
    startBtn.disabled=true; stopBtn.disabled=false; downloadBtn.disabled=true;
    cloudStatus.textContent='recording';

    // create session in Firebase
    sessionId=(crypto?.randomUUID?.() || String(Date.now()));
    sessionLabel.textContent=sessionId.slice(0,8)+'â€¦';

    set(ref(db,`public/sessions/${sessionId}/meta`),{
      startedAt:Date.now(),
      sdk:"web-logger",
      routeLabel:rLabel
    }).catch(()=>{});

    log(`Capture started. Route: "${rLabel}". Path: public/sessions/${sessionId}/readings`,'ok');

    // GPS
    if (hasGeoSupport()){
      watchId=navigator.geolocation.watchPosition((pos)=>{
        latestGeo=pos;
        const s=pos.coords.speed;
        gpsEl.textContent=`${pos.coords.latitude?.toFixed?.(5) ?? 'â€”'}, ${pos.coords.longitude?.toFixed?.(5) ?? 'â€”'} Â±${(pos.coords.accuracy||0).toFixed(0)}m`;
        speedEl.textContent=(s!=null? s.toFixed(2):'â€”');
      },(err)=>{ log('GPS error: '+err.message,'warn'); },{
        enableHighAccuracy:true,maximumAge:1000,timeout:10000
      });
    }

    startWeatherLoop();

    // motion
    motionHandler=ev=>{
      const aIncG=ev.accelerationIncludingGravity || ev.acceleration || {};
      lastAx=aIncG.x ?? null;
      lastAy=aIncG.y ?? null;
      lastAz=aIncG.z ?? null;
      lastAmag=(lastAx!=null && lastAy!=null && lastAz!=null)
        ? Math.sqrt(lastAx*lastAx+lastAy*lastAy+lastAz*lastAz) : null;
      if (lastAmag!=null) amagEl.textContent=lastAmag.toFixed(2);

      if (writeMode==='throttle'){
        const now=Date.now();
        if (minIntervalMs && (now-lastWriteTs)<minIntervalMs) return;
        lastWriteTs=now;
        pushRow(now);
      }
    };
    window.addEventListener('devicemotion',motionHandler,{passive:true});

    // timer mode
    if (writeMode==='timer'){
      if (timerId) clearInterval(timerId);
      timerId=setInterval(()=>{ pushRow(Date.now()); },intervalMs);
    }

    if (flushTimer) clearInterval(flushTimer);
    flushTimer=setInterval(flushBuffer,FLUSH_MS);

    setTimeout(()=>{
      if (recording && data.length===0){
        log('No samples yet. On iOS, ensure Motion & Orientation is enabled in Settings â†’ Safari, then move the phone slightly.','warn');
      }
    },5000);
  }

  function stopCapture(){
    if (!recording) return;
    recording=false;
    startBtn.disabled=false; stopBtn.disabled=true;
    downloadBtn.disabled=data.length===0;
    cloudStatus.textContent='stopped';

    if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    if (motionHandler){ window.removeEventListener('devicemotion',motionHandler); motionHandler=null; }
    if (timerId){ clearInterval(timerId); timerId=null; }
    if (flushTimer){ clearInterval(flushTimer); flushTimer=null; }
    stopWeatherLoop();

    flushBuffer().then(()=>{
      log(`Capture stopped. ${data.length} samples captured.`,'ok');
    });
  }

  function downloadCSV(){
    if (!data.length){ log('Nothing to download','warn'); return; }
    const headers=[
      'timestamp_iso','timestamp_ms','lat','lon','accuracy_m','altitude_m','speed_mps','heading_deg',
      'ax','ay','az','a_total',
      'dbfs','db_smooth','mic_active','tag','sample_id',
      'w_temp_c','w_wind_mps','w_precip_mm','w_ts','w_source'
    ];
    const csv=buildCSV(headers,data);
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    const ts=new Date().toISOString().replace(/:/g,'-');
    a.href=url; a.download=`sensor_log_${ts}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url),2000);
    log('CSV downloaded','ok');
  }

  function addTag(){
    const label=prompt('Tag label (e.g., obstruction, ramp, noisy segment...)');
    if (!label) return;
    tags.push({ts:Date.now(),label});
    lastTag=label;
    tagsEl.textContent=String(tags.length);
    log('Tagged: '+label,'ok');
  }

  // wire UI
  permBtn.addEventListener('click',requestPermissions);
  startBtn.addEventListener('click',startCapture);
  stopBtn.addEventListener('click',stopCapture);
  downloadBtn.addEventListener('click',downloadCSV);
  startMicBtn.addEventListener('click',startMic);
  stopMicBtn.addEventListener('click',stopMic);
  tagBtn.addEventListener('click',addTag);
  modeSel.addEventListener('change',()=>{
    writeMode=modeSel.value;
    applyRate(rateSel.value);
    log('Mode set to '+writeMode,'ok');
  });
  rateSel.addEventListener('change',()=>applyRate(rateSel.value));

  applyRate(rateSel.value);
  if (!hasMotionSupport()) log('DeviceMotion API not available; try a modern mobile browser.','err');
  if (!hasGeoSupport()) log('Geolocation not available.','warn');
</script>
</body>
</html>
